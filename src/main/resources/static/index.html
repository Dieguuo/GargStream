<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GargStream - Inicio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root {
        --primary-red: #e50914;
        --bg-color: #141414;
        --card-bg: #2f2f2f;
    }

    body {
        background-color: var(--bg-color);
        color: white;
        font-family: 'Roboto', sans-serif;
        margin: 0;
        overflow-x: hidden;
        padding-bottom: 50px;
    }

    /* --- CABECERA --- */
    .header-container {
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 4%; background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
        position: sticky; top: 0; z-index: 100; gap: 20px;
    }

    .brand-section h1 {
        margin: 0; color: var(--primary-red);
        font-family: 'Bebas Neue', sans-serif; font-size: 2.5em; letter-spacing: 2px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5); cursor: pointer;
    }

    .search-box { flex: 1; max-width: 400px; position: relative; }
    .search-input {
        width: 100%; padding: 10px 15px 10px 40px;
        background-color: rgba(0,0,0,0.6); border: 1px solid #444;
        color: white; border-radius: 4px; font-size: 1em;
        font-family: 'Roboto', sans-serif; transition: 0.3s;
    }
    .search-input:focus { border-color: #e50914; outline: none; background-color: rgba(0,0,0,0.8); }
    .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #aaa; }

    .btn-admin {
        background: rgba(51, 51, 51, 0.8); color: white; text-decoration: none;
        padding: 8px 15px; border-radius: 4px; border: 1px solid #555;
        font-weight: bold; transition: 0.3s; backdrop-filter: blur(5px); white-space: nowrap;
    }
    .btn-admin:hover { background: #e50914; border-color: #e50914; }

    /* --- SECCI√ìN HERO (NOVEDADES) --- */
    .hero-section {
        position: relative; padding: 20px 0; margin-bottom: 20px;
        overflow: hidden; touch-action: pan-y;
    }
    .hero-title {
        padding-left: 4%; margin-bottom: 0;
        font-family: 'Bebas Neue', sans-serif; font-size: 2em; letter-spacing: 1px; color: #fff;
    }
    .hero-track {
        display: flex; gap: 20px; width: max-content;
        padding: 60px 0;
        /* Usamos transform para mejor rendimiento */
        will-change: transform;
        cursor: grab;
    }
    .hero-track:active { cursor: grabbing; }

    .hero-card {
        flex: 0 0 220px; height: 330px; border-radius: 10px;
        background-size: cover; background-position: center;
        opacity: 0.4; transform: scale(0.85); filter: grayscale(80%);
        box-shadow: 0 5px 10px rgba(0,0,0,0.5);
        transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1); /* Transici√≥n suave */
        position: relative;
        border: 2px solid transparent; user-select: none; -webkit-user-drag: none;
    }
    .hero-card.active {
        opacity: 1; transform: scale(1.15); filter: grayscale(0%);
        border-color: rgba(255,255,255,0.4); z-index: 10;
        box-shadow: 0 0 40px rgba(229, 9, 20, 0.8); cursor: pointer;
    }

    .hero-nav {
        position: absolute; top: 55%; transform: translateY(-50%);
        width: 100%; display: flex; justify-content: space-between;
        pointer-events: none; padding: 0 2%; box-sizing: border-box; z-index: 20;
    }
    .nav-btn, .row-btn {
        pointer-events: auto; background: rgba(0,0,0,0.7); color: white;
        border: 1px solid rgba(255,255,255,0.3); font-size: 2em;
        width: 50px; height: 50px; border-radius: 50%;
        cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        z-index: 10;
    }
    .nav-btn:hover, .row-btn:hover { background: #e50914; border-color: #e50914; transform: scale(1.1); }


    /* --- FILAS EST√ÅNDAR --- */
    .category-row { margin-bottom: 40px; position: relative; min-height: 100px; }

    .category-title {
        padding-left: 4%; margin-bottom: 10px;
        font-family: 'Bebas Neue', sans-serif; font-size: 1.5em; letter-spacing: 1px; color: #ddd;
    }
    .category-title span { font-size: 0.6em; color: #666; font-family: 'Roboto', sans-serif; margin-left: 10px; letter-spacing: 0;}

    .row-wrapper { position: relative; padding: 0 4%; }

    .scroller {
        display: flex; gap: 10px; overflow-x: auto;
        padding: 10px 0; scroll-behavior: smooth;
        -ms-overflow-style: none; scrollbar-width: none;
    }
    .scroller::-webkit-scrollbar { display: none; }

    .row-btn {
        position: absolute; top: 50%; transform: translateY(-50%);
        font-size: 1.5em; width: 40px; height: 40px;
        background: rgba(20, 20, 20, 0.8); border: none; opacity: 0;
        transition: opacity 0.3s, transform 0.2s, background 0.2s;
    }
    .row-btn.left { left: 1%; }
    .row-btn.right { right: 1%; }
    .category-row:hover .row-btn { opacity: 1; }

    .standard-card {
        flex: 0 0 160px; background-color: var(--card-bg);
        border-radius: 5px; overflow: hidden;
        transition: transform 0.2s; cursor: pointer; position: relative;
    }
    .standard-card:hover { transform: scale(1.05); z-index: 5; box-shadow: 0 0 15px rgba(0,0,0,0.8); }
    .standard-card img { width: 100%; height: 240px; object-fit: cover; pointer-events: none;}
    .standard-info { padding: 8px; }
    .st-title {
        font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        font-weight: bold; margin-bottom: 3px;
    }
    .st-rating { font-size: 0.75em; color: #46d369; font-weight: bold; }

    .btn-delete {
        position: absolute; top: 5px; right: 5px;
        background: rgba(0,0,0,0.6); color: #fff;
        border: none; width: 24px; height: 24px; border-radius: 50%;
        display: none; align-items: center; justify-content: center;
        cursor: pointer; font-size: 1.2em; line-height: 1;
    }
    .btn-delete:hover { background: red; }
    .standard-card:hover .btn-delete { display: flex; }

  </style>
</head>
<body>

<div class="header-container">
  <div class="brand-section">
    <h1 onclick="window.location.reload()">GargStream</h1>
  </div>
  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" id="buscador" class="search-input" placeholder="T√≠tulos, g√©neros...">
  </div>
  <a href="admin.html" class="btn-admin">‚öôÔ∏è Panel Admin</a>
</div>

<div class="hero-section">
  <div class="hero-title">üî• Novedades y Tendencias</div>
  <div class="hero-nav">
    <button class="nav-btn" onclick="moverCarrusel(-1)">‚ùÆ</button>
    <button class="nav-btn" onclick="moverCarrusel(1)">‚ùØ</button>
  </div>
  <div style="width: 100%; overflow-x: hidden; overflow-y: visible;">
    <div class="hero-track" id="hero-track"></div>
  </div>
</div>

<div class="category-row" id="cat-peliculas">
  <div class="category-title">Pel√≠culas <span>Blockbusters y Cine</span></div>
  <div class="row-wrapper">
    <button class="row-btn left" onclick="deslizarFila('row-peliculas', -1)">‚ùÆ</button>
    <div class="scroller" id="row-peliculas"></div>
    <button class="row-btn right" onclick="deslizarFila('row-peliculas', 1)">‚ùØ</button>
  </div>
</div>

<div class="category-row" id="cat-series">
  <div class="category-title">Series de TV <span>Maratones √©picas</span></div>
  <div class="row-wrapper">
    <button class="row-btn left" onclick="deslizarFila('row-series', -1)">‚ùÆ</button>
    <div class="scroller" id="row-series"></div>
    <button class="row-btn right" onclick="deslizarFila('row-series', 1)">‚ùØ</button>
  </div>
</div>

<div class="category-row" id="cat-videos">
  <div class="category-title">V√≠deos Personales <span>Tus recuerdos</span></div>
  <div class="row-wrapper">
    <button class="row-btn left" onclick="deslizarFila('row-videos', -1)">‚ùÆ</button>
    <div class="scroller" id="row-videos"></div>
    <button class="row-btn right" onclick="deslizarFila('row-videos', 1)">‚ùØ</button>
  </div>
</div>

<script>
  // --- VARIABLES GLOBALES ---
  let catalogoCompleto = [];

  // Variables Hero Infinito
  let heroIndex = 0;
  let totalRealItems = 0;
  let cardWidth = 240;
  let isTransitioning = false;
  const heroTrack = document.getElementById('hero-track');

  // Variables T√°ctil
  let touchStartX = 0;
  let touchEndX = 0;
  // Variables Rueda
  let isWheelCooldown = false;


  // --- 1. CARGA INICIAL ---
  fetch('/api/public/novedades')
      .then(res => res.json())
      .then(data => renderHero(data))
      .catch(err => console.error("Error novedades", err));

  fetch('/api/public/catalogo')
      .then(res => res.json())
      .then(data => {
          catalogoCompleto = data;
          distribuirCatalogo(data);
      })
      .catch(err => console.error("Error catalogo", err));


  // --- 2. DISTRIBUCI√ìN ---
  function distribuirCatalogo(lista) {
      const pelis = lista.filter(item => item.rutaVideo && item.director);
      const series = lista.filter(item => !item.rutaVideo);
      const videos = lista.filter(item => item.rutaVideo && !item.director);

      renderRow(pelis, 'row-peliculas');
      renderRow(series, 'row-series');
      renderRow(videos, 'row-videos');
  }

  // --- 3. RENDERIZADO HERO (BUCLE PERFECTO) ---
  function renderHero(lista) {
      heroTrack.innerHTML = "";
      if(lista.length === 0) return;

      totalRealItems = lista.length;
      // Usamos 5 clones por lado para asegurar que cubren pantallas grandes
      const clonesInicio = lista.slice(-5);
      const clonesFin = lista.slice(0, 5);
      const listaInfinita = [...clonesInicio, ...lista, ...clonesFin];

      listaInfinita.forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'hero-card';
          div.style.backgroundImage = `url('${item.rutaCaratula || 'https://via.placeholder.com/220x330'}')`;
          div.onclick = () => {
              if(div.classList.contains('active')) {
                  window.location.href = `/ver_detalle.html?id=${item.id}`;
              } else {
                  const clickedIndex = index;
                  const diff = clickedIndex - heroIndex;
                  moverCarrusel(diff);
              }
          };
          heroTrack.appendChild(div);
      });

      // Posici√≥n inicial: √≠ndice 5 (primer elemento real)
      heroIndex = 5;
      actualizarPosicion(false);

      // Escuchar el final de la transici√≥n para hacer el "teletransporte" invisible
      heroTrack.addEventListener('transitionend', () => {
          isTransitioning = false;
          verificarLimites();
      });
  }

  // --- 4. GESTI√ìN DE EVENTOS (HERO) ---
  heroTrack.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
  heroTrack.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      if (touchEndX < touchStartX - 50) moverCarrusel(1);
      if (touchEndX > touchStartX + 50) moverCarrusel(-1);
  }, {passive: true});

  heroTrack.addEventListener('wheel', (e) => {
      if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) return;
      e.preventDefault();
      if (isWheelCooldown) return;
      if (e.deltaY > 0 || e.deltaX > 0) { moverCarrusel(1); activarCooldownRueda(); }
      else if (e.deltaY < 0 || e.deltaX < 0) { moverCarrusel(-1); activarCooldownRueda(); }
  }, { passive: false });

  function activarCooldownRueda() {
      isWheelCooldown = true;
      setTimeout(() => { isWheelCooldown = false; }, 500);
  }

  // --- 5. L√ìGICA DE MOVIMIENTO HERO ---
  function moverCarrusel(direccion) {
      if (isTransitioning) return;
      isTransitioning = true;
      heroIndex += direccion;
      actualizarPosicion(true);
  }

  function actualizarPosicion(animar) {
      const screenCenter = window.innerWidth / 2;
      const cardCenter = 110;
      const position = -(heroIndex * cardWidth) + screenCenter - cardCenter;

      if(animar) {
          heroTrack.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
      } else {
          heroTrack.style.transition = 'none';
      }

      heroTrack.style.transform = `translateX(${position}px)`;
      actualizarEstilosVisuales();
  }

  function verificarLimites() {
      // Si nos hemos pasado del √∫ltimo elemento real (entramos en clones finales)
      if (heroIndex >= totalRealItems + 5) {
          heroIndex = 5; // Saltamos al primero real
          actualizarPosicion(false);
          // TRUCO MAESTRO: Forzar Reflow para que el navegador aplique el cambio INSTANT√ÅNEAMENTE
          void heroTrack.offsetWidth;
      }
      // Si nos hemos pasado del primero real hacia atr√°s (entramos en clones iniciales)
      else if (heroIndex < 5) {
          heroIndex = totalRealItems + 5 - 1; // Saltamos al √∫ltimo real
          actualizarPosicion(false);
          void heroTrack.offsetWidth;
      }
  }

  function actualizarEstilosVisuales() {
      const cards = document.querySelectorAll('.hero-card');
      cards.forEach((card, index) => {
          if(index === heroIndex) card.classList.add('active');
          else card.classList.remove('active');
      });
  }

  window.addEventListener('resize', () => actualizarPosicion(false));

  // --- 6. RENDERIZADO FILAS EST√ÅNDAR ---
  function renderRow(lista, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      // Permitir scroll con rueda en filas horizontales
      container.addEventListener('wheel', (evt) => {
          evt.preventDefault();
          container.scrollLeft += evt.deltaY;
      });

      if(lista.length === 0) {
          container.innerHTML = "<p style='font-size:0.9em; color:#555; padding-left:10px;'>Sin resultados.</p>";
          return;
      }

      lista.forEach(item => {
          const img = item.rutaCaratula || 'https://via.placeholder.com/160x240?text=No+Img';
          const link = `/ver_detalle.html?id=${item.id}`;
          const rating = item.puntuacionMedia ? `‚≠ê ${item.puntuacionMedia}` : '';

          const div = document.createElement('div');
          div.className = 'standard-card';
          div.innerHTML = `
              <button class="btn-delete" onclick="borrarContenido(event, ${item.id})">&times;</button>
              <div onclick="window.location.href='${link}'">
                  <img src="${img}" loading="lazy" alt="${item.titulo}">
                  <div class="standard-info">
                      <div class="st-title">${item.titulo}</div>
                      <div class="st-rating">${rating}</div>
                  </div>
              </div>
          `;
          container.appendChild(div);
      });
  }

  // --- 7. DESLIZAR FILAS CON FLECHAS ---
  function deslizarFila(idContainer, direccion) {
      const container = document.getElementById(idContainer);
      const scrollAmount = window.innerWidth * 0.7; // 70% de la pantalla
      container.scrollBy({ left: direccion * scrollAmount, behavior: 'smooth' });
  }

  // --- 8. BUSCADOR ---
  document.getElementById('buscador').addEventListener('keyup', (e) => {
      const texto = e.target.value.toLowerCase();
      const filtrados = catalogoCompleto.filter(item =>
          item.titulo.toLowerCase().includes(texto)
      );
      distribuirCatalogo(filtrados);
  });

  // --- 9. BORRAR ---
  function borrarContenido(e, id) {
      e.stopPropagation();
      if(!confirm("¬øBorrar definitivamente?")) return;
      fetch('/api/admin/eliminar/' + id, { method: 'DELETE' })
          .then(res => {
              if(res.ok) window.location.reload();
              else alert("Error al borrar");
          });
  }

</script>
</body>
</html>