<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>GargStream - Inicio</title>
  <style>
    body {
        background-color: #141414;
        color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
    }

    /* CABECERA FLEXIBLE */
    .header-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .brand-section h1 { margin: 0; color: #e50914; }
    .brand-section p { margin: 5px 0 0 0; color: #aaa; }

    /* BUSCADOR */
    .search-box {
        flex: 1;
        max-width: 400px;
        position: relative;
        margin: 0 20px;
    }
    .search-input {
        width: 100%;
        padding: 12px 15px;
        background-color: #000;
        border: 1px solid #333;
        color: white;
        border-radius: 4px;
        font-size: 1em;
        padding-left: 35px;
    }
    .search-input:focus {
        border-color: #e50914;
        outline: none;
    }
    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #aaa;
    }

    /* GRID */
    .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px 0;
    }

    .card {
        background-color: #2f2f2f;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s;
        cursor: pointer;
        position: relative;
    }

    .card:hover {
        transform: scale(1.05);
        z-index: 2;
    }

    .card img {
        width: 100%;
        height: 300px;
        object-fit: cover;
    }

    .info {
        padding: 10px;
    }

    .titulo {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .tipo {
        font-size: 0.8em;
        color: #aaa;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .btn-accion {
        display: block;
        text-align: center;
        color: white;
        text-decoration: none;
        background: #e50914;
        padding: 8px;
        border-radius: 4px;
        margin-top: 10px;
        font-weight: bold;
        transition: background 0.2s;
    }
    .btn-accion:hover {
        background: #f40612;
    }

    .btn-delete {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 10;
    }

    .card:hover .btn-delete {
        opacity: 1;
    }

    .btn-delete:hover {
        background-color: red;
    }

    .btn-admin {
        background: #333;
        padding: 10px 15px;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        border: 1px solid #555;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: background 0.3s;
    }
    .btn-admin:hover {
        background: #444;
        border-color: #777;
    }

    #no-results {
        display: none;
        text-align: center;
        width: 100%;
        margin-top: 50px;
        color: #777;
        font-size: 1.5em;
    }
  </style>
</head>
<body>

<div class="header-container">
  <div class="brand-section">
    <h1>GargStream</h1>
    <p style="margin: 5px 0 0 0; color: #aaa;">Tu cat√°logo privado</p>
  </div>

  <div class="search-box">
    <span class="search-icon">üîç</span>
    <input type="text" id="buscador" class="search-input" placeholder="Buscar pel√≠culas, series...">
  </div>

  <a href="admin.html" class="btn-admin">
    ‚öôÔ∏è Gestionar Contenido
  </a>
</div>

<div class="grid-container" id="catalogo"></div>
<div id="no-results">No se encontraron coincidencias üòû</div>

<script>
  let todosLosContenidos = [];

  // --- 1. CARGA INICIAL ---
  fetch('/api/public/catalogo')
      .then(response => response.json())
      .then(contenidos => {
          todosLosContenidos = contenidos;
          renderizarCatalogo(contenidos);
      })
      .catch(error => console.error('Error cargando cat√°logo:', error));

  // --- 2. RENDERIZAR TARJETAS ---
  function renderizarCatalogo(lista) {
      const contenedor = document.getElementById('catalogo');
      const mensajeVacio = document.getElementById('no-results');
      contenedor.innerHTML = '';

      if(lista.length === 0) {
          mensajeVacio.style.display = 'block';
          return;
      } else {
          mensajeVacio.style.display = 'none';
      }

      lista.forEach(contenido => {
          const card = document.createElement('div');
          card.className = 'card';

          const imagen = contenido.rutaCaratula ? contenido.rutaCaratula : 'https://via.placeholder.com/200x300?text=Sin+Imagen';

          let tipo = "Video Personal";

          // --- AQU√ç EST√Å EL CAMBIO CLAVE ---
          // Antes: Pelis -> V√≠deo directo / Series -> ver_serie.html
          // Ahora: TODO -> ver_detalle.html
          let link = `/ver_detalle.html?id=${contenido.id}`;

          let textoBoton = "Ver Ficha"; // Texto gen√©rico para todos
          let target = '_self'; // Se abre en la misma pesta√±a

          if (!contenido.rutaVideo) {
              tipo = "Serie TV";
              textoBoton = "Ver Cap√≠tulos";
          } else if (contenido.director) {
              tipo = "Pel√≠cula";
              textoBoton = "Ver Pel√≠cula";
          }

          card.innerHTML = `
              <button class="btn-delete" onclick="borrarContenido(${contenido.id}, this)" title="Borrar">
                  &times;
              </button>

              <a href="${link}" style="text-decoration:none; color:inherit;">
                  <img src="${imagen}" alt="${contenido.titulo}">
                  <div class="info">
                      <div class="titulo" title="${contenido.titulo}">${contenido.titulo}</div>
                      <div class="tipo">${tipo}</div>
                      <div style="font-size:0.9em; color: #ffd700;">‚≠ê ${contenido.puntuacionMedia || '-'}</div>

                      <div class="btn-accion">
                          ${textoBoton}
                      </div>
                  </div>
              </a>
          `;

          contenedor.appendChild(card);
      });
  }

  // --- 3. BUSCADOR ---
  const inputBuscador = document.getElementById('buscador');
  inputBuscador.addEventListener('keyup', (e) => {
      const texto = e.target.value.toLowerCase();
      const filtrados = todosLosContenidos.filter(item => item.titulo.toLowerCase().includes(texto));
      renderizarCatalogo(filtrados);
  });

  // --- 4. BORRAR ---
  function borrarContenido(id, boton) {
        // Importante: detener la propagaci√≥n para no entrar en la ficha al borrar
        event.preventDefault();
        event.stopPropagation();

        if(!confirm("¬øSeguro que quieres borrar esto?")) return;

        fetch('/api/admin/eliminar/' + id, { method: 'DELETE' })
        .then(response => {
            if(response.ok) {
                todosLosContenidos = todosLosContenidos.filter(c => c.id !== id);
                const tarjeta = boton.parentElement;
                tarjeta.style.transition = "transform 0.5s, opacity 0.5s";
                tarjeta.style.transform = "scale(0)";
                tarjeta.style.opacity = "0";
                setTimeout(() => tarjeta.remove(), 500);
            } else {
                alert("Error al borrar.");
            }
        })
        .catch(error => console.error(error));
    }
</script>

</body>
</html>