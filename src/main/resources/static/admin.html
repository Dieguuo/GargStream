<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administraci√≥n - GargStream</title>
    <style>
        body { background-color: #141414; color: white; font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh;}

        /* BARRA LATERAL */
        .sidebar { width: 250px; background-color: #000; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .sidebar h2 { color: #e50914; margin-bottom: 30px; }
        .menu-btn {
            background: none; border: none; color: #aaa;
            text-align: left; padding: 15px; cursor: pointer;
            font-size: 1.1em; transition: 0.3s; width: 100%;
            border-radius: 5px; margin-bottom: 5px;
        }
        .menu-btn:hover, .menu-btn.active { background-color: #333; color: white; }
        .back-link { margin-top: auto; color: #aaa; text-decoration: none; padding: 10px; }
        .back-link:hover { color: white; }

        /* AREA DE CONTENIDO */
        .content { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;}

        /* FORMULARIOS */
        .form-section { display: none; max-width: 600px; }
        .form-section.active { display: block; animation: fadeIn 0.5s; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        label { display: block; margin-top: 15px; color: #e50914; font-weight: bold; font-size: 0.9em; }
        input[type="text"], input[type="number"], textarea, input[type="file"], select {
            width: 100%; padding: 10px; margin-top: 5px;
            background-color: #333; border: 1px solid #444; color: white; border-radius: 4px;
        }

        /* Estilo especial para el desplegable */
        select { cursor: pointer; color: white; }
        select option { background-color: #333; }

        button[type="submit"], .btn-cancelar {
            background-color: #e50914; color: white; border: none;
            padding: 12px 20px; margin-top: 20px; cursor: pointer;
            font-size: 1em; font-weight: bold; border-radius: 4px; width: 100%;
        }
        button[type="submit"]:hover { background-color: #f40612; }

        .btn-cancelar { background-color: #666; margin-top: 10px; }
        .btn-cancelar:hover { background-color: #888; }

        /* Bot√≥n de eliminar (Rojo oscuro) */
        .btn-eliminar {
            background-color: #8b0000; color: white; border: 1px solid #ff0000;
            margin-top: 30px; /* Separado del resto */
            padding: 12px 20px; cursor: pointer; font-size: 1em;
            font-weight: bold; border-radius: 4px; width: 100%;
        }
        .btn-eliminar:hover { background-color: #ff0000; }

        .row { display: flex; gap: 10px; }

        /* CONSOLA DE RESULTADOS */
        #console-box {
            background-color: #0d0d0d; border: 1px solid #333; border-radius: 8px; padding: 15px;
            font-family: 'Courier New', monospace; color: #0f0; min-height: 150px; max-height: 300px;
            overflow: auto; white-space: pre-wrap; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); display: none;
        }
        .console-title { color: #555; font-size: 0.8em; margin-bottom: 5px; text-transform: uppercase;}

        /* --- NUEVOS ESTILOS PARA EDICI√ìN --- */
        .grid-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
        }
        .card-edit {
            background: #222; border-radius: 5px; overflow: hidden;
            cursor: pointer; transition: transform 0.2s; border: 1px solid transparent;
        }
        .card-edit:hover { transform: scale(1.05); border-color: #e50914; }
        .card-edit img { width: 100%; height: 220px; object-fit: cover; }
        .card-edit p { padding: 10px; margin: 0; font-size: 0.9em; text-align: center; color: #ddd; }

        .edit-form-container { display: none; border: 1px solid #444; padding: 20px; border-radius: 10px; background: #1a1a1a; }
        .section-separator { border-top: 1px solid #333; margin: 20px 0; padding-top: 10px; }
        .section-title { color: #aaa; margin-bottom: 10px; font-size: 1.1em; border-left: 3px solid #e50914; padding-left: 10px; }

        /* --- ESTILOS DASHBOARD --- */
        .dash-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;
        }
        .dash-card {
            background: #222; padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #333;
        }
        .dash-number { font-size: 3em; font-weight: bold; color: #e50914; margin: 10px 0; }
        .dash-label { color: #aaa; font-size: 1.1em; text-transform: uppercase; }

        /* Barra de progreso disco */
        .progress-container { width: 100%; background-color: #444; border-radius: 5px; height: 10px; margin-top: 10px; overflow: hidden;}
        .progress-bar { height: 100%; width: 0%; background-color: #e50914; transition: width 1s; }
        .disk-info { display: flex; justify-content: space-between; font-size: 0.8em; color: #888; margin-top: 5px;}
    </style>
</head>
<body>

<div class="sidebar">
    <h2>‚öôÔ∏è Admin Panel</h2>

    <button class="menu-btn active" onclick="mostrar('sec-dashboard'); cargarMetricas()">üìä Resumen</button>

    <button class="menu-btn" onclick="mostrar('sec-cine')">üé¨ Nueva Pel√≠cula</button>
    <button class="menu-btn" onclick="mostrar('sec-serie')">üì∫ Nueva Serie</button>
    <button class="menu-btn" onclick="mostrar('sec-capitulo'); cargarSeriesEnSelector()">‚ñ∂Ô∏è Nuevo Cap√≠tulo</button>
    <button class="menu-btn" onclick="mostrar('sec-video')">üìπ Video Personal</button>

    <button class="menu-btn" onclick="mostrar('sec-editar'); cargarContenidoParaEditar()">‚úèÔ∏è Editar / Gestionar</button>

    <a href="index.html" class="back-link">‚Üê Volver al Cat√°logo</a>
</div>

<div class="content">

    <div id="console-box">
        <div class="console-title">Estado del Servidor:</div>
        <div id="console-content">Esperando acci√≥n...</div>
    </div>

    <div id="sec-dashboard" class="form-section active" style="max-width: 100%;">
        <h1>Estado del Servidor</h1>

        <div class="dash-grid">
            <div class="dash-card">
                <div class="dash-label">Pel√≠culas</div>
                <div class="dash-number" id="metric-pelis">-</div>
            </div>
            <div class="dash-card">
                <div class="dash-label">Series</div>
                <div class="dash-number" id="metric-series">-</div>
            </div>
            <div class="dash-card">
                <div class="dash-label">V√≠deos</div>
                <div class="dash-number" id="metric-videos">-</div>
            </div>
            <div class="dash-card">
                <div class="dash-label">Disco Usado</div>
                <div class="dash-number" id="metric-espacio" style="font-size: 2em; color: #fff;">-</div>

                <div class="progress-container">
                    <div class="progress-bar" id="disk-bar"></div>
                </div>
                <div class="disk-info">
                    <span id="disk-used">0 GB</span>
                    <span id="disk-total">Total: 0 GB</span>
                </div>
            </div>
        </div>

        <p style="color:#666; text-align: center;">Bienvenido al panel de control de GargStream.</p>
    </div>

    <div id="sec-cine" class="form-section">
        <h1>Subir Pel√≠cula</h1>
        <p style="color:#aaa; font-size:0.9em;">Escribe el t√≠tulo y sube el archivo. El servidor buscar√° la car√°tula y sinopsis autom√°ticamente.</p>
        <form action="/api/admin/nueva-pelicula" onsubmit="enviarFormulario(event)">
            <label>T√≠tulo:</label>
            <input type="text" name="titulo" required placeholder="Ej: El Padrino">

            <label>Archivo de V√≠deo (Obligatorio):</label>
            <input type="file" name="archivo" required accept="video/*">

            <label>Subt√≠tulos (.srt o .vtt) - Opcional:</label>
            <input type="file" name="subtitulo" accept=".srt,.vtt">

            <button type="submit">Subir Pel√≠cula</button>
        </form>
    </div>

    <div id="sec-serie" class="form-section">
        <h1>Crear Ficha de Serie</h1>
        <form action="/api/admin/nueva-serie" onsubmit="enviarFormulario(event)">
            <label>T√≠tulo de la Serie:</label>
            <input type="text" name="titulo" required placeholder="Ej: Breaking Bad">

            <button type="submit">Crear Ficha</button>
        </form>
    </div>

    <div id="sec-capitulo" class="form-section">
        <h1>Subir Cap√≠tulo</h1>
        <form action="/api/admin/nuevo-capitulo" onsubmit="enviarFormulario(event)">

            <label>Selecciona la Serie:</label>
            <select name="idSerie" id="selector-series" required>
                <option value="" disabled selected>Cargando series...</option>
            </select>

            <div class="row">
                <div style="flex:1">
                    <label>Temporada:</label>
                    <input type="number" name="numTemporada" required value="1">
                </div>
                <div style="flex:1">
                    <label>Cap√≠tulo:</label>
                    <input type="number" name="numCapitulo" required value="1">
                </div>
            </div>

            <label>T√≠tulo del Cap√≠tulo:</label>
            <input type="text" name="titulo" placeholder="Ej: Piloto">

            <label>Archivo de V√≠deo (Obligatorio):</label>
            <input type="file" name="archivo" required accept="video/*">

            <label>Subt√≠tulos (.srt o .vtt) - Opcional:</label>
            <input type="file" name="subtitulo" accept=".srt,.vtt">

            <button type="submit">Subir Cap√≠tulo</button>
        </form>
    </div>

    <div id="sec-video" class="form-section">
        <h1>Subir Video Personal</h1>
        <form action="/api/admin/nuevo-video" onsubmit="enviarFormulario(event)">
            <label>T√≠tulo:</label>
            <input type="text" name="titulo" required>
            <label>Autor:</label>
            <input type="text" name="autor" placeholder="Yo">
            <label>Descripci√≥n:</label>
            <textarea name="descripcion" rows="3"></textarea>

            <label>Archivo de V√≠deo (Obligatorio):</label>
            <input type="file" name="archivo" required accept="video/*">

            <label>Subt√≠tulos (.srt o .vtt) - Opcional:</label>
            <input type="file" name="subtitulo" accept=".srt,.vtt">

            <button type="submit">Subir Video</button>
        </form>
    </div>

    <div id="sec-editar" class="form-section" style="max-width: 900px;">
        <h1>Gestionar Contenido</h1>
        <p style="color:#aaa;">Haz clic en una car√°tula para editar sus datos.</p>

        <div id="grid-edicion" class="grid-content">
        </div>

        <div id="formulario-edicion" class="edit-form-container">
            <h2 style="margin-top:0;">Editando: <span id="edit-titulo-display" style="color:#e50914"></span></h2>

            <form action="/api/admin/editar-contenido" onsubmit="enviarFormulario(event)">
                <input type="hidden" name="id" id="edit-id">

                <div class="row">
                    <div style="flex:1">
                        <label>T√≠tulo:</label>
                        <input type="text" name="titulo" id="edit-titulo">
                    </div>
                    <div style="flex:1">
                        <label>ID Youtube Trailer:</label>
                        <input type="text" name="youtubeTrailerId" id="edit-trailer" placeholder="Ej: dQw4w9WgXcQ">
                    </div>
                </div>

                <label>Sinopsis:</label>
                <textarea name="sipnosis" id="edit-sinopsis" rows="4"></textarea>

                <div class="section-separator"></div>
                <div class="section-title">üìÇ Archivos (Opcional)</div>
                <p style="font-size:0.8em; color:#777;">Solo sube archivos si quieres cambiar/a√±adir algo.</p>

                <label>Cambiar Car√°tula:</label>
                <input type="file" name="archivoCaratula" accept="image/*">

                <div class="section-separator"></div>
                <div class="section-title">üåç A√±adir Nuevo Subt√≠tulo</div>

                <div class="row">
                    <div style="flex:1">
                        <label>Idioma (c√≥digo):</label>
                        <select name="idiomaSub">
                            <option value="es">Espa√±ol (es)</option>
                            <option value="en">Ingl√©s (en)</option>
                            <option value="fr">Franc√©s (fr)</option>
                            <option value="de">Alem√°n (de)</option>
                            <option value="it">Italiano (it)</option>
                            <option value="pt">Portugu√©s (pt)</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Etiqueta (Lo que se ve):</label>
                        <input type="text" name="nombreSub" placeholder="Ej: Espa√±ol, English (CC)">
                    </div>
                </div>

                <label>Archivo Subt√≠tulo (.vtt / .srt):</label>
                <input type="file" name="archivoSubtitulo" accept=".srt,.vtt">

                <button type="submit">üíæ Guardar Cambios</button>
                <button type="button" class="btn-cancelar" onclick="cerrarEditor()">Cancelar</button>

                <button type="button" class="btn-eliminar" onclick="eliminarContenido()">üóëÔ∏è ELIMINAR CONTENIDO</button>
            </form>
        </div>
    </div>

</div>

<script>
    // --- 0. INICIO AUTOM√ÅTICO ---
    // Cargar m√©tricas nada m√°s abrir la p√°gina
    document.addEventListener("DOMContentLoaded", () => {
        cargarMetricas();
    });

    // --- 1. GESTI√ìN DE PESTA√ëAS ---
    function mostrar(idSeccion) {
        document.querySelectorAll('.form-section').forEach(div => div.classList.remove('active'));
        document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(idSeccion).classList.add('active');
        document.getElementById('console-box').style.display = 'none';

        const botones = document.querySelectorAll('.menu-btn');
        // Actualizamos los √≠ndices porque hemos a√±adido un bot√≥n nuevo al principio
        if(idSeccion === 'sec-dashboard') botones[0].classList.add('active');
        if(idSeccion === 'sec-cine') botones[1].classList.add('active');
        if(idSeccion === 'sec-serie') botones[2].classList.add('active');
        if(idSeccion === 'sec-capitulo') botones[3].classList.add('active');
        if(idSeccion === 'sec-video') botones[4].classList.add('active');
        if(idSeccion === 'sec-editar') botones[5].classList.add('active');
    }

    // --- 2. CARGAR M√âTRICAS DASHBOARD ---
    async function cargarMetricas() {
        try {
            const res = await fetch('/api/admin/metricas');
            if(res.ok) {
                const data = await res.json();

                // Animaci√≥n simple de n√∫meros
                document.getElementById('metric-pelis').innerText = data.peliculas;
                document.getElementById('metric-series').innerText = data.series;
                document.getElementById('metric-videos').innerText = data.videos;

                // Disco duro
                document.getElementById('metric-espacio').innerText = data.porcentaje + "%";
                document.getElementById('disk-used').innerText = data.usado;
                document.getElementById('disk-total').innerText = "Total: " + data.total;

                // Barra visual
                const barra = document.getElementById('disk-bar');
                barra.style.width = data.porcentaje + "%";

                // Color seg√∫n lo lleno que est√©
                if(data.porcentaje > 90) barra.style.backgroundColor = "#ff0000"; // Peligro
                else if(data.porcentaje > 70) barra.style.backgroundColor = "#ffa500"; // Aviso
                else barra.style.backgroundColor = "#46d369"; // Bien
            }
        } catch (e) {
            console.error("Error cargando m√©tricas", e);
        }
    }

    // --- 3. CARGAR SERIES EN EL SELECTOR ---
    async function cargarSeriesEnSelector() {
        const selector = document.getElementById('selector-series');
        selector.innerHTML = '<option value="" disabled selected>‚è≥ Buscando series...</option>';

        try {
            const response = await fetch('/api/public/catalogo');
            const data = await response.json();
            const series = data.filter(item => !item.rutaVideo); // Filtrar solo series

            selector.innerHTML = '<option value="" disabled selected>-- Elige una Serie --</option>';

            if(series.length === 0) {
                const option = document.createElement('option');
                option.text = "No hay series creadas todav√≠a";
                selector.add(option);
            } else {
                series.forEach(serie => {
                    const option = document.createElement('option');
                    option.value = serie.id;
                    option.text = serie.titulo;
                    selector.add(option);
                });
            }

        } catch (error) {
            console.error(error);
            selector.innerHTML = '<option value="" disabled selected>‚ùå Error al cargar</option>';
        }
    }

    // --- 4. NUEVO: CARGAR CONTENIDO PARA EDITAR ---
    async function cargarContenidoParaEditar() {
        // Ocultar formulario si estaba abierto
        cerrarEditor();
        const grid = document.getElementById('grid-edicion');
        grid.innerHTML = '<p>Cargando contenido...</p>';

        try {
            const response = await fetch('/api/public/catalogo');
            const data = await response.json();
            grid.innerHTML = '';

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card-edit';
                div.onclick = () => abrirEditor(item.id); // Al hacer clic, abrimos editor

                const img = item.rutaCaratula ? item.rutaCaratula : 'https://via.placeholder.com/150x220?text=No+Cover';

                div.innerHTML = `
                    <img src="${img}" alt="${item.titulo}">
                    <p>${item.titulo}</p>
                `;
                grid.appendChild(div);
            });

        } catch (error) {
            grid.innerHTML = '<p style="color:red">Error cargando cat√°logo.</p>';
        }
    }

    // --- 5. NUEVO: ABRIR EL EDITOR Y RELLENAR DATOS ---
    async function abrirEditor(id) {
        // 1. Ocultar grid, mostrar formulario
        document.getElementById('grid-edicion').style.display = 'none';
        const formContainer = document.getElementById('formulario-edicion');
        formContainer.style.display = 'block';
        formContainer.scrollIntoView({ behavior: 'smooth' });

        // 2. Pedir datos frescos del contenido
        try {
            const response = await fetch('/api/public/contenido/' + id);
            const data = await response.json();

            // 3. Rellenar campos
            document.getElementById('edit-id').value = data.id;
            document.getElementById('edit-titulo-display').textContent = data.titulo;
            document.getElementById('edit-titulo').value = data.titulo || '';
            document.getElementById('edit-sinopsis').value = data.sipnosis || data.sinopsis || ''; // A veces es sipnosis/sinopsis
            document.getElementById('edit-trailer').value = data.youtubeTrailerId || '';

        } catch (e) {
            alert("Error al cargar datos del contenido");
            cerrarEditor();
        }
    }

    function cerrarEditor() {
        document.getElementById('formulario-edicion').style.display = 'none';
        document.getElementById('grid-edicion').style.display = 'grid';
        // Limpiar formulario (opcional)
        document.querySelector('#formulario-edicion form').reset();
    }

    // --- 6. ENV√çO DE FORMULARIOS (AJAX) ---
    async function enviarFormulario(event) {
        event.preventDefault();

        const form = event.target;
        const consola = document.getElementById('console-box');
        const contenidoConsola = document.getElementById('console-content');
        const boton = form.querySelector('button[type="submit"]');

        consola.style.display = 'block';
        contenidoConsola.textContent = "‚è≥ Procesando solicitud...";
        contenidoConsola.style.color = "#ffff00";
        boton.disabled = true;
        boton.style.opacity = "0.5";

        try {
            const formData = new FormData(form);
            const response = await fetch(form.action, { method: 'POST', body: formData });

            if (response.ok) {
                // √âXITO (200)
                const json = await response.json();
                contenidoConsola.textContent = "‚úÖ ¬°√âXITO!\n" + JSON.stringify(json, null, 4);
                contenidoConsola.style.color = "#0f0";

                // Si estamos en el editor, no reseteamos todo el form para no perder el ID
                // Pero si estamos creando, s√≠ reseteamos
                if(!form.action.includes("editar-contenido")) {
                    form.reset();
                } else {
                    // Si editamos, cerramos el editor tras 1 segundo y refrescamos la lista
                    setTimeout(() => {
                        cerrarEditor();
                        cargarContenidoParaEditar();
                        consola.style.display = 'none';
                        // Actualizar m√©tricas tambi√©n por si se ha borrado algo
                        cargarMetricas();
                    }, 1500);
                }

                if(form.action.includes("nuevo-capitulo")) {
                    cargarSeriesEnSelector();
                }

                // Actualizar m√©tricas si hemos a√±adido algo
                cargarMetricas();

            } else {
                // ERROR
                const textoError = await response.text();
                contenidoConsola.textContent = textoError;
                contenidoConsola.style.color = "#ff4444";
            }
        } catch (error) {
            console.error(error);
            contenidoConsola.textContent = "‚ùå Error de conexi√≥n: " + error.message;
            contenidoConsola.style.color = "#ff4444";
        } finally {
            boton.disabled = false;
            boton.style.opacity = "1";
        }
    }

    // --- 7. FUNCI√ìN PARA BORRAR (NUEVA) ---
    async function eliminarContenido() {
        // 1. Obtener el ID oculto del formulario
        const id = document.getElementById('edit-id').value;
        const titulo = document.getElementById('edit-titulo-display').innerText;

        // 2. Preguntar al usuario (Seguridad)
        if(!confirm(`‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nVas a eliminar "${titulo}" y todos sus archivos.\nEsta acci√≥n no se puede deshacer.`)) {
            return; // Si dice "Cancelar", no hacemos nada
        }

        // 3. Llamar al servidor
        try {
            const response = await fetch('/api/admin/eliminar-contenido/' + id, {
                method: 'DELETE'
            });

            if(response.ok) {
                alert("‚úÖ Eliminado correctamente");
                cerrarEditor();           // Ocultar formulario
                cargarContenidoParaEditar(); // Refrescar la lista (la peli desaparecer√°)
                cargarMetricas(); // Actualizar dashboard
            } else {
                alert("‚ùå Error al eliminar: " + await response.text());
            }
        } catch (e) {
            alert("‚ùå Error de conexi√≥n");
        }
    }
</script>
</body>
</html>